var __pow=Math.pow,__async=(e,t,s)=>new Promise(((i,r)=>{var o=e=>{try{a(s.next(e))}catch(t){r(t)}},n=e=>{try{a(s.throw(e))}catch(t){r(t)}},a=e=>e.done?i(e.value):Promise.resolve(e.value).then(o,n);a((s=s.apply(e,t)).next())}));!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@pixi/utils"),require("@pixi/math"),require("@pixi/core"),require("@pixi/display")):"function"==typeof define&&define.amd?define(["exports","@pixi/utils","@pixi/math","@pixi/core","@pixi/display"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).PIXI=e.PIXI||{},e.PIXI.live2d=e.PIXI.live2d||{}),e.PIXI.utils,e.PIXI,e.PIXI,e.PIXI)}(this,(function(e,t,s,i,r){"use strict";var o,n,a;(n=o||(o={})).supportMoreMaskDivisions=!0,n.setOpacityFromMotion=!1,e.config=void 0,(a=e.config||(e.config={})).LOG_LEVEL_VERBOSE=0,a.LOG_LEVEL_WARNING=1,a.LOG_LEVEL_ERROR=2,a.LOG_LEVEL_NONE=999,a.logLevel=a.LOG_LEVEL_WARNING,a.sound=!0,a.motionSync=!0,a.motionFadingDuration=500,a.idleMotionFadingDuration=2e3,a.expressionFadingDuration=500,a.preserveExpressionOnMotion=!0,a.cubism4=o;const l={log(t,...s){e.config.logLevel<=e.config.LOG_LEVEL_VERBOSE&&console.log(`[${t}]`,...s)},warn(t,...s){e.config.logLevel<=e.config.LOG_LEVEL_WARNING&&console.warn(`[${t}]`,...s)},error(t,...s){e.config.logLevel<=e.config.LOG_LEVEL_ERROR&&console.error(`[${t}]`,...s)}};function d(e,t,s){return e<t?t:e>s?s:e}function h(e,t){return Math.random()*(t-e)+e}function u(e,t,s,i,r){const o=t[i];null!==o&&typeof o===e&&(s[r]=o)}function c(e,t,s,i,r){const o=t[i];Array.isArray(o)&&(s[r]=o.filter((t=>null!==t&&typeof t===e)))}function p(e,t){t.forEach((t=>{Object.getOwnPropertyNames(t.prototype).forEach((s=>{"constructor"!==s&&Object.defineProperty(e.prototype,s,Object.getOwnPropertyDescriptor(t.prototype,s))}))}))}function g(e){let t=e.lastIndexOf("/");return-1!=t&&(e=e.slice(0,t)),t=e.lastIndexOf("/"),-1!==t&&(e=e.slice(t+1)),e}function m(e,t){const s=e.indexOf(t);-1!==s&&e.splice(s,1)}class f extends t.EventEmitter{constructor(e,t){super(),this.expressions=[],this.reserveExpressionIndex=-1,this.destroyed=!1,this.settings=e,this.tag=`ExpressionManager(${e.name})`}init(){this.defaultExpression=this.createExpression({},void 0),this.currentExpression=this.defaultExpression,this.stopAllExpressions()}loadExpression(e){return __async(this,null,(function*(){if(!this.definitions[e])return void l.warn(this.tag,`Undefined expression at [${e}]`);if(null===this.expressions[e])return void l.warn(this.tag,`Cannot set expression at [${e}] because it's already failed in loading.`);if(this.expressions[e])return this.expressions[e];const t=yield this._loadExpression(e);return this.expressions[e]=t,t}))}_loadExpression(e){throw new Error("Not implemented.")}setRandomExpression(){return __async(this,null,(function*(){if(this.definitions.length){const e=[];for(let t=0;t<this.definitions.length;t++)null!==this.expressions[t]&&this.expressions[t]!==this.currentExpression&&t!==this.reserveExpressionIndex&&e.push(t);if(e.length){const t=Math.floor(Math.random()*e.length);return this.setExpression(t)}}return!1}))}resetExpression(){this._setExpression(this.defaultExpression)}restoreExpression(){this._setExpression(this.currentExpression)}setExpression(e){return __async(this,null,(function*(){if("number"!=typeof e&&(e=this.getExpressionIndex(e)),!(e>-1&&e<this.definitions.length))return!1;if(e===this.expressions.indexOf(this.currentExpression))return!1;this.reserveExpressionIndex=e;const t=yield this.loadExpression(e);return!(!t||this.reserveExpressionIndex!==e)&&(this.reserveExpressionIndex=-1,this.currentExpression=t,this._setExpression(t),!0)}))}update(e,t){return!this.isFinished()&&this.updateParameters(e,t)}destroy(){this.destroyed=!0,this.emit("destroy");this.definitions=void 0,this.expressions=void 0}}class x{constructor(){this.targetX=0,this.targetY=0,this.x=0,this.y=0,this.vx=0,this.vy=0}focus(e,t,s=!1){this.targetX=d(e,-1,1),this.targetY=d(t,-1,1),s&&(this.x=this.targetX,this.y=this.targetY)}update(e){const t=this.targetX-this.x,s=this.targetY-this.y;if(Math.abs(t)<.01&&Math.abs(s)<.01)return;const i=Math.sqrt(__pow(t,2)+__pow(s,2)),r=5.333333333333333/(1e3/e);let o=r*(t/i)-this.vx,n=r*(s/i)-this.vy;const a=Math.sqrt(__pow(o,2)+__pow(n,2)),l=.006666666666666667*r*e;a>l&&(o*=l/a,n*=l/a),this.vx+=o,this.vy+=n;const d=Math.sqrt(__pow(this.vx,2)+__pow(this.vy,2)),h=.5*(Math.sqrt(__pow(l,2)+8*l*i)-l);d>h&&(this.vx*=h/d,this.vy*=h/d),this.x+=this.vx,this.y+=this.vy}}class y{constructor(e){this.json=e;let t=e.url;if("string"!=typeof t)throw new TypeError("The `url` field in settings JSON must be defined as a string.");this.url=t,this.name=g(this.url)}resolveURL(e){return t.url.resolve(this.url,e)}replaceFiles(e){this.moc=e(this.moc,"moc"),void 0!==this.pose&&(this.pose=e(this.pose,"pose")),void 0!==this.physics&&(this.physics=e(this.physics,"physics"));for(let t=0;t<this.textures.length;t++)this.textures[t]=e(this.textures[t],`textures[${t}]`)}getDefinedFiles(){const e=[];return this.replaceFiles((t=>(e.push(t),t))),e}validateFiles(e){const t=(t,s)=>{const i=this.resolveURL(t);if(!e.includes(i)){if(s)throw new Error(`File "${t}" is defined in settings, but doesn't exist in given files`);return!1}return!0};[this.moc,...this.textures].forEach((e=>t(e,!0)));return this.getDefinedFiles().filter((e=>t(e,!1)))}}var M=(e=>(e[e.NONE=0]="NONE",e[e.IDLE=1]="IDLE",e[e.NORMAL=2]="NORMAL",e[e.FORCE=3]="FORCE",e))(M||{});class v{constructor(){this.debug=!1,this.currentPriority=0,this.reservePriority=0}reserve(e,t,s){if(s<=0)return l.log(this.tag,"Cannot start a motion with MotionPriority.NONE."),!1;if(e===this.currentGroup&&t===this.currentIndex)return l.log(this.tag,"Motion is already playing.",this.dump(e,t)),!1;if(e===this.reservedGroup&&t===this.reservedIndex||e===this.reservedIdleGroup&&t===this.reservedIdleIndex)return l.log(this.tag,"Motion is already reserved.",this.dump(e,t)),!1;if(1===s){if(0!==this.currentPriority)return l.log(this.tag,"Cannot start idle motion because another motion is playing.",this.dump(e,t)),!1;if(void 0!==this.reservedIdleGroup)return l.log(this.tag,"Cannot start idle motion because another idle motion has reserved.",this.dump(e,t)),!1;this.setReservedIdle(e,t)}else{if(s<3){if(s<=this.currentPriority)return l.log(this.tag,"Cannot start motion because another motion is playing as an equivalent or higher priority.",this.dump(e,t)),!1;if(s<=this.reservePriority)return l.log(this.tag,"Cannot start motion because another motion has reserved as an equivalent or higher priority.",this.dump(e,t)),!1}this.setReserved(e,t,s)}return!0}start(e,t,s,i){if(1===i){if(this.setReservedIdle(void 0,void 0),0!==this.currentPriority)return l.log(this.tag,"Cannot start idle motion because another motion is playing.",this.dump(t,s)),!1}else{if(t!==this.reservedGroup||s!==this.reservedIndex)return l.log(this.tag,"Cannot start motion because another motion has taken the place.",this.dump(t,s)),!1;this.setReserved(void 0,void 0,0)}return!!e&&(this.setCurrent(t,s,i),!0)}complete(){this.setCurrent(void 0,void 0,0)}setCurrent(e,t,s){this.currentPriority=s,this.currentGroup=e,this.currentIndex=t}setReserved(e,t,s){this.reservePriority=s,this.reservedGroup=e,this.reservedIndex=t}setReservedIdle(e,t){this.reservedIdleGroup=e,this.reservedIdleIndex=t}isActive(e,t){return e===this.currentGroup&&t===this.currentIndex||e===this.reservedGroup&&t===this.reservedIndex||e===this.reservedIdleGroup&&t===this.reservedIdleIndex}reset(){this.setCurrent(void 0,void 0,0),this.setReserved(void 0,void 0,0),this.setReservedIdle(void 0,void 0)}shouldRequestIdleMotion(){return void 0===this.currentGroup&&void 0===this.reservedIdleGroup}shouldOverrideExpression(){return!e.config.preserveExpressionOnMotion&&this.currentPriority>1}dump(e,t){if(this.debug){return`\n<Requested> group = "${e}", index = ${t}\n`+["currentPriority","reservePriority","currentGroup","currentIndex","reservedGroup","reservedIndex","reservedIdleGroup","reservedIdleIndex"].map((e=>"["+e+"] "+this[e])).join("\n")}return""}}class E{static get volume(){return this._volume}static set volume(e){this._volume=(e>1?1:e<0?0:e)||0,this.audios.forEach((e=>e.volume=this._volume))}static add(e,t,s){const i=new Audio(e);return i.volume=this._volume,i.preload="auto",i.autoplay=!0,i.crossOrigin="anonymous",i.addEventListener("ended",(()=>{this.dispose(i),null==t||t()})),i.addEventListener("error",(t=>{this.dispose(i),l.warn("SoundManager",`Error occurred on "${e}"`,t.error),null==s||s(t.error)})),this.audios.push(i),i}static play(e){return new Promise(((t,s)=>{var i;null==(i=e.play())||i.catch((t=>{e.dispatchEvent(new ErrorEvent("error",{error:t})),s(t)})),e.readyState===e.HAVE_ENOUGH_DATA?t():e.addEventListener("canplaythrough",t)}))}static addContext(e){const t=new AudioContext;return this.contexts.push(t),t}static addAnalyzer(e,t){const s=t.createMediaElementSource(e),i=t.createAnalyser();return i.fftSize=256,i.minDecibels=-90,i.maxDecibels=-10,i.smoothingTimeConstant=.85,s.connect(i),i.connect(t.destination),this.analysers.push(i),i}static analyze(e){if(null!=e){let t=new Float32Array(e.fftSize),s=0;e.getFloatTimeDomainData(t);for(const e of t)s+=e*e;return parseFloat(Math.sqrt(s/t.length*20).toFixed(1))}return parseFloat(Math.random().toFixed(1))}static dispose(e){e.pause(),e.removeAttribute("src"),m(this.audios,e)}static destroy(){for(let e=this.contexts.length-1;e>=0;e--)this.contexts[e].close();for(let e=this.audios.length-1;e>=0;e--)this.dispose(this.audios[e])}}E.audios=[],E.analysers=[],E.contexts=[],E._volume=.9;var w=(e=>(e.ALL="ALL",e.IDLE="IDLE",e.NONE="NONE",e))(w||{});class P extends t.EventEmitter{constructor(e,t){super(),this.motionGroups={},this.state=new v,this.playing=!1,this.destroyed=!1,this.settings=e,this.tag=`MotionManager(${e.name})`,this.state.tag=this.tag}init(e){(null==e?void 0:e.idleMotionGroup)&&(this.groups.idle=e.idleMotionGroup),this.setupMotions(e),this.stopAllMotions()}setupMotions(e){for(const s of Object.keys(this.definitions))this.motionGroups[s]=[];let t;switch(null==e?void 0:e.motionPreload){case"NONE":return;case"ALL":t=Object.keys(this.definitions);break;default:t=[this.groups.idle]}for(const s of t)if(this.definitions[s])for(let e=0;e<this.definitions[s].length;e++)this.loadMotion(s,e).then()}loadMotion(e,t){return __async(this,null,(function*(){var s;if(!(null==(s=this.definitions[e])?void 0:s[t]))return void l.warn(this.tag,`Undefined motion at "${e}"[${t}]`);if(null===this.motionGroups[e][t])return void l.warn(this.tag,`Cannot start motion at "${e}"[${t}] because it's already failed in loading.`);if(this.motionGroups[e][t])return this.motionGroups[e][t];const i=yield this._loadMotion(e,t);return this.destroyed?void 0:(this.motionGroups[e][t]=null!=i?i:null,i)}))}_loadMotion(e,t){throw new Error("Not implemented.")}speakUp(t){return __async(this,arguments,(function*(t,{volume:s=1,expression:i,resetExpression:r=!0}={}){if(!e.config.sound)return!1;let o,n,a,d;if(this.currentAudio&&!this.currentAudio.ended)return!1;const h=t&&t.startsWith("data:audio/wav;base64");if(t&&!h){var u=document.createElement("a");u.href=t,d=t=u.href}else d="data:audio/wav;base64";let c;(t&&(t.startsWith("http")||t.startsWith("blob"))||h)&&(c=t);const p=this;if(c)try{o=E.add(c,(()=>{r&&i&&p.expressionManager&&p.expressionManager.resetExpression(),p.currentAudio=void 0}),(()=>{r&&i&&p.expressionManager&&p.expressionManager.resetExpression(),p.currentAudio=void 0})),this.currentAudio=o;let e=1;void 0!==s&&(e=s),E.volume=e,a=E.addContext(this.currentAudio),this.currentContext=a,n=E.addAnalyzer(this.currentAudio,this.currentContext),this.currentAnalyzer=n}catch(g){l.warn(this.tag,"Failed to create audio",d,g)}if(o){const t=E.play(o).catch((e=>l.warn(this.tag,"Failed to play audio",o.src,e)));e.config.motionSync&&(yield t)}return this.state.shouldOverrideExpression()&&this.expressionManager&&this.expressionManager.resetExpression(),i&&this.expressionManager&&this.expressionManager.setExpression(i),this.playing=!0,!0}))}startMotion(t,s){return __async(this,arguments,(function*(t,s,i=M.NORMAL,{sound:r,volume:o=1,expression:n,resetExpression:a=!0}={}){var d;if(this.currentAudio&&!this.currentAudio.ended)return!1;if(!this.state.reserve(t,s,i))return!1;const h=null==(d=this.definitions[t])?void 0:d[s];if(!h)return!1;let u,c,p;if(this.currentAudio&&E.dispose(this.currentAudio),e.config.sound){const e=r&&r.startsWith("data:audio/wav;base64");if(r&&!e){var g=document.createElement("a");g.href=r,r=g.href}const t=r&&(r.startsWith("http")||r.startsWith("blob")),s=this.getSoundFile(h);let i=s;s&&(i=this.settings.resolveURL(s)+"?cache-buster="+(new Date).getTime()),(t||e)&&(i=r);const d=this;if(i)try{u=E.add(i,(()=>{a&&n&&d.expressionManager&&d.expressionManager.resetExpression(),d.currentAudio=void 0}),(()=>{a&&n&&d.expressionManager&&d.expressionManager.resetExpression(),d.currentAudio=void 0})),this.currentAudio=u;let e=1;void 0!==o&&(e=o),E.volume=e,p=E.addContext(this.currentAudio),this.currentContext=p,c=E.addAnalyzer(this.currentAudio,this.currentContext),this.currentAnalyzer=c}catch(f){l.warn(this.tag,"Failed to create audio",s,f)}}const m=yield this.loadMotion(t,s);if(u){i=3;const t=E.play(u).catch((e=>l.warn(this.tag,"Failed to play audio",u.src,e)));e.config.motionSync&&(yield t)}return this.state.start(m,t,s,i)?(this.state.shouldOverrideExpression()&&this.expressionManager&&this.expressionManager.resetExpression(),l.log(this.tag,"Start motion:",this.getMotionName(h)),this.emit("motionStart",t,s,u),n&&this.expressionManager&&this.expressionManager.setExpression(n),this.playing=!0,this._startMotion(m),!0):(u&&(E.dispose(u),this.currentAudio=void 0),!1)}))}startRandomMotion(e,t){return __async(this,arguments,(function*(e,t,{sound:s,volume:i=1,expression:r,resetExpression:o=!0}={}){const n=this.definitions[e];if(null==n?void 0:n.length){const a=[];for(let t=0;t<n.length;t++)null===this.motionGroups[e][t]||this.state.isActive(e,t)||a.push(t);if(a.length){const n=a[Math.floor(Math.random()*a.length)];return this.startMotion(e,n,t,{sound:s,volume:i,expression:r,resetExpression:o})}}return!1}))}stopSpeaking(){this.currentAudio&&(E.dispose(this.currentAudio),this.currentAudio=void 0)}stopAllMotions(){this._stopAllMotions(),this.state.reset(),this.stopSpeaking()}update(e,t){var s;return this.isFinished()&&(this.playing&&(this.playing=!1,this.emit("motionFinish")),this.state.shouldOverrideExpression()&&(null==(s=this.expressionManager)||s.restoreExpression()),this.state.complete(),this.state.shouldRequestIdleMotion()&&this.startRandomMotion(this.groups.idle,M.IDLE)),this.updateParameters(e,t)}mouthSync(){return this.currentAnalyzer?E.analyze(this.currentAnalyzer):0}destroy(){var e;this.destroyed=!0,this.emit("destroy"),this.stopAllMotions(),null==(e=this.expressionManager)||e.destroy();this.definitions=void 0,this.motionGroups=void 0}}const _={x:0,y:0,width:0,height:0};class I extends t.EventEmitter{constructor(){super(...arguments),this.focusController=new x,this.originalWidth=0,this.originalHeight=0,this.width=0,this.height=0,this.localTransform=new s.Matrix,this.drawingMatrix=new s.Matrix,this.hitAreas={},this.textureFlipY=!1,this.viewport=[0,0,0,0],this.destroyed=!1}init(){this.setupLayout(),this.setupHitAreas()}setupLayout(){const e=this,t=this.getSize();e.originalWidth=t[0],e.originalHeight=t[1];const s=Object.assign({width:2,height:2},this.getLayout());this.localTransform.scale(s.width/2,s.height/2),e.width=this.originalWidth*this.localTransform.a,e.height=this.originalHeight*this.localTransform.d;const i=void 0!==s.x&&s.x-s.width/2||void 0!==s.centerX&&s.centerX||void 0!==s.left&&s.left-s.width/2||void 0!==s.right&&s.right+s.width/2||0,r=void 0!==s.y&&s.y-s.height/2||void 0!==s.centerY&&s.centerY||void 0!==s.top&&s.top-s.height/2||void 0!==s.bottom&&s.bottom+s.height/2||0;this.localTransform.translate(this.width*i,-this.height*r)}setupHitAreas(){const e=this.getHitAreaDefs().filter((e=>e.index>=0));for(const t of e)this.hitAreas[t.name]=t}hitTest(e,t){return Object.keys(this.hitAreas).filter((s=>this.isHit(s,e,t)))}isHit(e,t,s){if(!this.hitAreas[e])return!1;const i=this.hitAreas[e].index,r=this.getDrawableBounds(i,_);return r.x<=t&&t<=r.x+r.width&&r.y<=s&&s<=r.y+r.height}getDrawableBounds(e,t){const s=this.getDrawableVertices(e);let i=s[0],r=s[0],o=s[1],n=s[1];for(let a=0;a<s.length;a+=2){const e=s[a],t=s[a+1];i=Math.min(e,i),r=Math.max(e,r),o=Math.min(t,o),n=Math.max(t,n)}return null!=t||(t={}),t.x=i,t.y=o,t.width=r-i,t.height=n-o,t}updateTransform(e){this.drawingMatrix.copyFrom(e).append(this.localTransform)}update(e,t){this.focusController.update(e)}destroy(){this.destroyed=!0,this.emit("destroy"),this.motionManager.destroy(),this.motionManager=void 0}}class L extends Error{constructor(e,t,s,i=!1){super(e),this.url=t,this.status=s,this.aborted=i}}const b=class{static createXHR(e,t,s,i,r){const o=new XMLHttpRequest;if(b.allXhrSet.add(o),e){let t=b.xhrMap.get(e);t?t.add(o):(t=new Set([o]),b.xhrMap.set(e,t)),e.listeners("destroy").includes(b.cancelXHRs)||e.once("destroy",b.cancelXHRs)}return o.open("GET",t),o.responseType=s,o.onload=()=>{200!==o.status&&0!==o.status||!o.response?o.onerror():i(o.response)},o.onerror=()=>{l.warn("XHRLoader",`Failed to load resource as ${o.responseType} (Status ${o.status}): ${t}`),r(new L("Network error.",t,o.status))},o.onabort=()=>r(new L("Aborted.",t,o.status,!0)),o.onloadend=()=>{var t;b.allXhrSet.delete(o),e&&(null==(t=b.xhrMap.get(e))||t.delete(o))},o}static cancelXHRs(){var e;null==(e=b.xhrMap.get(this))||e.forEach((e=>{e.abort(),b.allXhrSet.delete(e)})),b.xhrMap.delete(this)}static release(){b.allXhrSet.forEach((e=>e.abort())),b.allXhrSet.clear(),b.xhrMap=new WeakMap}};let T=b;function O(e,t){let s=-1;return function i(r,o){if(o)return Promise.reject(o);if(r<=s)return Promise.reject(new Error("next() called multiple times"));s=r;const n=e[r];if(!n)return Promise.resolve();try{return Promise.resolve(n(t,i.bind(null,r+1)))}catch(a){return Promise.reject(a)}}(0)}T.xhrMap=new WeakMap,T.allXhrSet=new Set,T.loader=(e,t)=>new Promise(((t,s)=>{b.createXHR(e.target,e.settings?e.settings.resolveURL(e.url):e.url,e.type,(s=>{e.result=s,t()}),s).send()}));class A{static load(e){return O(this.middlewares,e).then((()=>e.result))}}A.middlewares=[T.loader];const R="Live2DFactory",F=(e,t)=>__async(this,null,(function*(){if("string"==typeof e.source){const t=yield A.load({url:e.source,type:"json",target:e.live2dModel});t.url=e.source,e.source=t,e.live2dModel.emit("settingsJSONLoaded",t)}return t()})),D=(e,t)=>__async(this,null,(function*(){if(e.source instanceof y)return e.settings=e.source,t();if("object"==typeof e.source){const s=N.findRuntime(e.source);if(s){const i=s.createModelSettings(e.source);return e.settings=i,e.live2dModel.emit("settingsLoaded",i),t()}}throw new TypeError("Unknown settings format.")})),S=(e,t)=>{if(e.settings){const s=N.findRuntime(e.settings);if(s)return s.ready().then(t)}return t()},C=(e,t)=>__async(this,null,(function*(){yield t();const s=e.internalModel;if(s){const t=e.settings,i=N.findRuntime(t);if(i){const r=[];t.pose&&r.push(A.load({settings:t,url:t.pose,type:"json",target:s}).then((t=>{s.pose=i.createPose(s.coreModel,t),e.live2dModel.emit("poseLoaded",s.pose)})).catch((t=>{e.live2dModel.emit("poseLoadError",t),l.warn(R,"Failed to load pose.",t)}))),t.physics&&r.push(A.load({settings:t,url:t.physics,type:"json",target:s}).then((t=>{s.physics=i.createPhysics(s.coreModel,t),e.live2dModel.emit("physicsLoaded",s.physics)})).catch((t=>{e.live2dModel.emit("physicsLoadError",t),l.warn(R,"Failed to load physics.",t)}))),r.length&&(yield Promise.all(r))}}})),k=(e,t)=>__async(this,null,(function*(){if(!e.settings)throw new TypeError("Missing settings.");{const s=e.live2dModel,r=e.settings.textures.map((t=>function(e,t={}){const s={resourceOptions:{crossorigin:t.crossOrigin}};if(i.Texture.fromURL)return i.Texture.fromURL(e,s).catch((e=>{if(e instanceof Error)throw e;const t=new Error("Texture loading error");throw t.event=e,t}));s.resourceOptions.autoLoad=!1;const r=i.Texture.from(e,s);if(r.baseTexture.valid)return Promise.resolve(r);const o=r.baseTexture.resource;return null!=o._live2d_load||(o._live2d_load=new Promise(((e,t)=>{const s=e=>{o.source.removeEventListener("error",s);const i=new Error("Texture loading error");i.event=e,t(i)};o.source.addEventListener("error",s),o.load().then((()=>e(r))).catch(s)}))),o._live2d_load}(e.settings.resolveURL(t),{crossOrigin:e.options.crossOrigin})));if(yield t(),!e.internalModel)throw new TypeError("Missing internal model.");s.internalModel=e.internalModel,s.emit("modelLoaded",e.internalModel),s.textures=yield Promise.all(r),s.emit("textureLoaded",s.textures)}})),U=(e,t)=>__async(this,null,(function*(){const s=e.settings;if(s instanceof y){const i=N.findRuntime(s);if(!i)throw new TypeError("Unknown model settings.");const r=yield A.load({settings:s,url:s.moc,type:"arraybuffer",target:e.live2dModel});if(!i.isValidMoc(r))throw new Error("Invalid moc data");const o=i.createCoreModel(r);return e.internalModel=i.createInternalModel(o,s,e.options),t()}throw new TypeError("Missing settings.")})),G=class{static registerRuntime(e){G.runtimes.push(e),G.runtimes.sort(((e,t)=>t.version-e.version))}static findRuntime(e){for(const t of G.runtimes)if(t.test(e))return t}static setupLive2DModel(e,t,s){return __async(this,null,(function*(){const i=new Promise((t=>e.once("textureLoaded",t))),r=new Promise((t=>e.once("modelLoaded",t))),o=Promise.all([i,r]).then((()=>e.emit("ready")));yield O(G.live2DModelMiddlewares,{live2dModel:e,source:t,options:s||{}}),yield o,e.emit("load")}))}static loadMotion(e,t,s){var i;const r=i=>e.emit("motionLoadError",t,s,i);try{const o=null==(i=e.definitions[t])?void 0:i[s];if(!o)return Promise.resolve(void 0);e.listeners("destroy").includes(G.releaseTasks)||e.once("destroy",G.releaseTasks);let n=G.motionTasksMap.get(e);n||(n={},G.motionTasksMap.set(e,n));let a=n[t];a||(a=[],n[t]=a);const d=e.getMotionFile(o);return null!=a[s]||(a[s]=A.load({url:d,settings:e.settings,type:e.motionDataType,target:e}).then((i=>{var r;const n=null==(r=G.motionTasksMap.get(e))?void 0:r[t];n&&delete n[s];const a=e.createMotion(i,t,o);return e.emit("motionLoaded",t,s,a),a})).catch((t=>{l.warn(e.tag,`Failed to load motion: ${d}\n`,t),r(t)}))),a[s]}catch(o){l.warn(e.tag,`Failed to load motion at "${t}"[${s}]\n`,o),r(o)}return Promise.resolve(void 0)}static loadExpression(e,t){const s=s=>e.emit("expressionLoadError",t,s);try{const i=e.definitions[t];if(!i)return Promise.resolve(void 0);e.listeners("destroy").includes(G.releaseTasks)||e.once("destroy",G.releaseTasks);let r=G.expressionTasksMap.get(e);r||(r=[],G.expressionTasksMap.set(e,r));const o=e.getExpressionFile(i);return null!=r[t]||(r[t]=A.load({url:o,settings:e.settings,type:"json",target:e}).then((s=>{const r=G.expressionTasksMap.get(e);r&&delete r[t];const o=e.createExpression(s,i);return e.emit("expressionLoaded",t,o),o})).catch((t=>{l.warn(e.tag,`Failed to load expression: ${o}\n`,t),s(t)}))),r[t]}catch(i){l.warn(e.tag,`Failed to load expression at [${t}]\n`,i),s(i)}return Promise.resolve(void 0)}static releaseTasks(){this instanceof P?G.motionTasksMap.delete(this):G.expressionTasksMap.delete(this)}};let N=G;N.runtimes=[],N.urlToJSON=F,N.jsonToSettings=D,N.waitUntilReady=S,N.setupOptionals=C,N.setupEssentials=k,N.createInternalModel=U,N.live2DModelMiddlewares=[F,D,S,C,k,U],N.motionTasksMap=new WeakMap,N.expressionTasksMap=new WeakMap,P.prototype._loadMotion=function(e,t){return N.loadMotion(this,e,t)},f.prototype._loadExpression=function(e){return N.loadExpression(this,e)};class j{constructor(){this._autoInteract=!1}get autoInteract(){return this._autoInteract}set autoInteract(e){e!==this._autoInteract&&(e?this.on("pointertap",X,this):this.off("pointertap",X,this),this._autoInteract=e)}registerInteraction(e){e!==this.interactionManager&&(this.unregisterInteraction(),this._autoInteract&&e&&(this.interactionManager=e,e.on("pointermove",H,this)))}unregisterInteraction(){var e;this.interactionManager&&(null==(e=this.interactionManager)||e.off("pointermove",H,this),this.interactionManager=void 0)}}function X(e){this.tap(e.data.global.x,e.data.global.y)}function H(e){this.focus(e.data.global.x,e.data.global.y)}class W extends s.Transform{}const $=new s.Point,q=new s.Matrix;let V;class Y extends r.Container{constructor(e){super(),this.tag="Live2DModel(uninitialized)",this.textures=[],this.transform=new W,this.anchor=new s.ObservablePoint(this.onAnchorChange,this,0,0),this.glContextID=-1,this.elapsedTime=performance.now(),this.deltaTime=0,this._autoUpdate=!1,this.once("modelLoaded",(()=>this.init(e)))}static from(e,t){const s=new this(t);return N.setupLive2DModel(s,e,t).then((()=>s))}static fromSync(e,t){const s=new this(t);return N.setupLive2DModel(s,e,t).then(null==t?void 0:t.onLoad).catch(null==t?void 0:t.onError),s}static registerTicker(e){V=e}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){var t;V||(V=null==(t=window.PIXI)?void 0:t.Ticker),e?this._destroyed||(V?(V.shared.add(this.onTickerUpdate,this),this._autoUpdate=!0):l.warn(this.tag,"No Ticker registered, please call Live2DModel.registerTicker(Ticker).")):(null==V||V.shared.remove(this.onTickerUpdate,this),this._autoUpdate=!1)}init(e){this.tag=`Live2DModel(${this.internalModel.settings.name})`;const t=Object.assign({autoUpdate:!0,autoInteract:!0},e);t.autoInteract&&(this.interactive=!0),this.autoInteract=t.autoInteract,this.autoUpdate=t.autoUpdate}onAnchorChange(){this.pivot.set(this.anchor.x*this.internalModel.width,this.anchor.y*this.internalModel.height)}motion(e,t,{priority:s=2,sound:i,volume:r=1,expression:o,resetExpression:n=!0}={}){return void 0===t?this.internalModel.motionManager.startRandomMotion(e,s,{sound:i,volume:r,expression:o,resetExpression:n}):this.internalModel.motionManager.startMotion(e,t,s,{sound:i,volume:r,expression:o,resetExpression:n})}resetMotions(){return this.internalModel.motionManager.stopAllMotions()}speak(e,{volume:t=1,expression:s,resetExpression:i=!0}={}){return this.internalModel.motionManager.speakUp(e,{volume:t,expression:s,resetExpression:i})}stopSpeaking(){return this.internalModel.motionManager.stopSpeaking()}expression(e){return this.internalModel.motionManager.expressionManager?void 0===e?this.internalModel.motionManager.expressionManager.setRandomExpression():this.internalModel.motionManager.expressionManager.setExpression(e):Promise.resolve(!1)}focus(e,t,s=!1){$.x=e,$.y=t,this.toModelPosition($,$,!0);let i=$.x/this.internalModel.originalWidth*2-1,r=$.y/this.internalModel.originalHeight*2-1,o=Math.atan2(r,i);this.internalModel.focusController.focus(Math.cos(o),-Math.sin(o),s)}tap(e,t){const s=this.hitTest(e,t);s.length&&(l.log(this.tag,"Hit",s),this.emit("hit",s))}hitTest(e,t){return $.x=e,$.y=t,this.toModelPosition($,$),this.internalModel.hitTest($.x,$.y)}toModelPosition(e,t=e.clone(),s){return s||(this._recursivePostUpdateTransform(),this.parent?this.displayObjectUpdateTransform():(this.parent=this._tempDisplayObjectParent,this.displayObjectUpdateTransform(),this.parent=null)),this.transform.worldTransform.applyInverse(e,t),this.internalModel.localTransform.applyInverse(t,t),t}containsPoint(e){return this.getBounds(!0).contains(e.x,e.y)}_calculateBounds(){this._bounds.addFrame(this.transform,0,0,this.internalModel.width,this.internalModel.height)}onTickerUpdate(){this.update(V.shared.deltaMS)}update(e){this.deltaTime+=e,this.elapsedTime+=e}_render(e){this.registerInteraction(e.plugins.interaction),e.batch.reset(),e.geometry.reset(),e.shader.reset(),e.state.reset();let t=!1;this.glContextID!==e.CONTEXT_UID&&(this.glContextID=e.CONTEXT_UID,this.internalModel.updateWebGLContext(e.gl,this.glContextID),t=!0);for(let r=0;r<this.textures.length;r++){const s=this.textures[r];s.valid&&(!t&&s.baseTexture._glTextures[this.glContextID]||(e.gl.pixelStorei(WebGLRenderingContext.UNPACK_FLIP_Y_WEBGL,this.internalModel.textureFlipY),e.texture.bind(s.baseTexture,0)),this.internalModel.bindTexture(r,s.baseTexture._glTextures[this.glContextID].texture),s.baseTexture.touched=e.textureGC.count)}const s=e.framebuffer.viewport;this.internalModel.viewport=[s.x,s.y,s.width,s.height],this.deltaTime&&(this.internalModel.update(this.deltaTime,this.elapsedTime),this.deltaTime=0);const i=q.copyFrom(e.globalUniforms.uniforms.projectionMatrix).append(this.worldTransform);this.internalModel.updateTransform(i),this.internalModel.draw(e.gl),e.state.reset(),e.texture.reset()}destroy(e){this.emit("destroy"),this.autoUpdate=!1,this.unregisterInteraction(),(null==e?void 0:e.texture)&&this.textures.forEach((t=>t.destroy(e.baseTexture))),this.internalModel.destroy(),super.destroy(e)}}p(Y,[j]);const z=class{static resolveURL(e,t){var s;const i=null==(s=z.filesMap[e])?void 0:s[t];if(void 0===i)throw new Error("Cannot find this file from uploaded files: "+t);return i}static upload(e,s){return __async(this,null,(function*(){const i={};for(const r of s.getDefinedFiles()){const o=decodeURI(t.url.resolve(s.url,r)),n=e.find((e=>e.webkitRelativePath===o));n&&(i[r]=URL.createObjectURL(n))}z.filesMap[s._objectURL]=i}))}static createSettings(e){return __async(this,null,(function*(){const t=e.find((e=>e.name.endsWith("model.json")||e.name.endsWith("model3.json")));if(!t)throw new TypeError("Settings file not found");const s=yield z.readText(t),i=JSON.parse(s);i.url=t.webkitRelativePath;const r=N.findRuntime(i);if(!r)throw new Error("Unknown settings JSON");const o=r.createModelSettings(i);return o._objectURL=URL.createObjectURL(t),o}))}static readText(e){return __async(this,null,(function*(){return new Promise(((t,s)=>{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=s,i.readAsText(e,"utf8")}))}))}};let B=z;B.filesMap={},B.factory=(e,t)=>__async(this,null,(function*(){if(Array.isArray(e.source)&&e.source[0]instanceof File){const t=e.source;let s=t.settings;if(s){if(!s._objectURL)throw new Error('"_objectURL" must be specified in ModelSettings')}else s=yield z.createSettings(t);s.validateFiles(t.map((e=>encodeURI(e.webkitRelativePath)))),yield z.upload(t,s),s.resolveURL=function(e){return z.resolveURL(this._objectURL,e)},e.source=s,e.live2dModel.once("modelLoaded",(e=>{e.once("destroy",(function(){const e=this.settings._objectURL;if(URL.revokeObjectURL(e),z.filesMap[e])for(const t of Object.values(z.filesMap[e]))URL.revokeObjectURL(t);delete z.filesMap[e]}))}))}return t()})),N.live2DModelMiddlewares.unshift(B.factory);const J=class{static unzip(e,s){return __async(this,null,(function*(){const i=yield J.getFilePaths(e),r=[];for(const e of s.getDefinedFiles()){const o=decodeURI(t.url.resolve(s.url,e));i.includes(o)&&r.push(o)}const o=yield J.getFiles(e,r);for(let e=0;e<o.length;e++){const t=r[e],s=o[e];Object.defineProperty(s,"webkitRelativePath",{value:t})}return o}))}static createSettings(e){return __async(this,null,(function*(){const t=(yield J.getFilePaths(e)).find((e=>e.endsWith("model.json")||e.endsWith("model3.json")));if(!t)throw new Error("Settings file not found");const s=yield J.readText(e,t);if(!s)throw new Error("Empty settings file: "+t);const i=JSON.parse(s);i.url=t;const r=N.findRuntime(i);if(!r)throw new Error("Unknown settings JSON");return r.createModelSettings(i)}))}static zipReader(e,t){return __async(this,null,(function*(){throw new Error("Not implemented")}))}static getFilePaths(e){return __async(this,null,(function*(){throw new Error("Not implemented")}))}static getFiles(e,t){return __async(this,null,(function*(){throw new Error("Not implemented")}))}static readText(e,t){return __async(this,null,(function*(){throw new Error("Not implemented")}))}static releaseReader(e){}};let Z=J;if(Z.ZIP_PROTOCOL="zip://",Z.uid=0,Z.factory=(e,t)=>__async(this,null,(function*(){const s=e.source;let i,r,o;if("string"==typeof s&&(s.endsWith(".zip")||s.startsWith(J.ZIP_PROTOCOL))?(i=s.startsWith(J.ZIP_PROTOCOL)?s.slice(J.ZIP_PROTOCOL.length):s,r=yield A.load({url:i,type:"blob",target:e.live2dModel})):Array.isArray(s)&&1===s.length&&s[0]instanceof File&&s[0].name.endsWith(".zip")&&(r=s[0],i=URL.createObjectURL(r),o=s.settings),r){if(!r.size)throw new Error("Empty zip file");const t=yield J.zipReader(r,i);o||(o=yield J.createSettings(t)),o._objectURL=J.ZIP_PROTOCOL+J.uid+"/"+o.url;const s=yield J.unzip(t,o);s.settings=o,e.source=s,i.startsWith("blob:")&&e.live2dModel.once("modelLoaded",(e=>{e.once("destroy",(function(){URL.revokeObjectURL(i)}))})),J.releaseReader(t)}return t()})),N.live2DModelMiddlewares.unshift(Z.factory),!window.Live2D)throw new Error("Could not find Cubism 2 runtime. This plugin requires live2d.min.js to be loaded.");const Q=Live2DMotion.prototype.updateParam;Live2DMotion.prototype.updateParam=function(e,t){Q.call(this,e,t),t.isFinished()&&this.onFinishHandler&&(this.onFinishHandler(this),delete this.onFinishHandler)};class K extends AMotion{constructor(t){super(),this.params=[],this.setFadeIn(t.fade_in>0?t.fade_in:e.config.expressionFadingDuration),this.setFadeOut(t.fade_out>0?t.fade_out:e.config.expressionFadingDuration),Array.isArray(t.params)&&t.params.forEach((e=>{const t=e.calc||"add";if("add"===t){const t=e.def||0;e.val-=t}else if("mult"===t){const t=e.def||1;e.val/=t}this.params.push({calc:t,val:e.val,id:e.id})}))}updateParamExe(e,t,s,i){this.params.forEach((t=>{e.setParamFloat(t.id,t.val*s)}))}}class ee extends f{constructor(e,t){var s;super(e,t),this.queueManager=new MotionQueueManager,this.definitions=null!=(s=this.settings.expressions)?s:[],this.init()}isFinished(){return this.queueManager.isFinished()}getExpressionIndex(e){return this.definitions.findIndex((t=>t.name===e))}getExpressionFile(e){return e.file}createExpression(e,t){return new K(e)}_setExpression(e){return this.queueManager.startMotion(e)}stopAllExpressions(){this.queueManager.stopAllMotions()}updateParameters(e,t){return this.queueManager.updateParam(e)}}class te extends P{constructor(e,t){super(e,t),this.groups={idle:"idle"},this.motionDataType="arraybuffer",this.queueManager=new MotionQueueManager,this.definitions=this.settings.motions,this.init(t),this.lipSyncIds=["PARAM_MOUTH_OPEN_Y"]}init(e){super.init(e),this.settings.expressions&&(this.expressionManager=new ee(this.settings,e))}isFinished(){return this.queueManager.isFinished()}createMotion(t,s,i){const r=Live2DMotion.loadMotion(t),o=s===this.groups.idle?e.config.idleMotionFadingDuration:e.config.motionFadingDuration;return r.setFadeIn(i.fade_in>0?i.fade_in:o),r.setFadeOut(i.fade_out>0?i.fade_out:o),r}getMotionFile(e){return e.file}getMotionName(e){return e.file}getSoundFile(e){return e.sound}_startMotion(e,t){return e.onFinishHandler=t,this.queueManager.stopAllMotions(),this.queueManager.startMotion(e)}_stopAllMotions(){this.queueManager.stopAllMotions()}updateParameters(e,t){return this.queueManager.updateParam(e)}destroy(){super.destroy(),this.queueManager=void 0}}class se{constructor(e){this.coreModel=e,this.blinkInterval=4e3,this.closingDuration=100,this.closedDuration=50,this.openingDuration=150,this.eyeState=0,this.eyeParamValue=1,this.closedTimer=0,this.nextBlinkTimeLeft=this.blinkInterval,this.leftParam=e.getParamIndex("PARAM_EYE_L_OPEN"),this.rightParam=e.getParamIndex("PARAM_EYE_R_OPEN")}setEyeParams(e){this.eyeParamValue=d(e,0,1),this.coreModel.setParamFloat(this.leftParam,this.eyeParamValue),this.coreModel.setParamFloat(this.rightParam,this.eyeParamValue)}update(e){switch(this.eyeState){case 0:this.nextBlinkTimeLeft-=e,this.nextBlinkTimeLeft<0&&(this.eyeState=1,this.nextBlinkTimeLeft=this.blinkInterval+this.closingDuration+this.closedDuration+this.openingDuration+h(0,2e3));break;case 1:this.setEyeParams(this.eyeParamValue+e/this.closingDuration),this.eyeParamValue<=0&&(this.eyeState=2,this.closedTimer=0);break;case 2:this.closedTimer+=e,this.closedTimer>=this.closedDuration&&(this.eyeState=3);break;case 3:this.setEyeParams(this.eyeParamValue+e/this.openingDuration),this.eyeParamValue>=1&&(this.eyeState=0)}}}const ie=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class re extends I{constructor(e,t,s){super(),this.textureFlipY=!0,this.lipSync=!0,this.drawDataCount=0,this.disableCulling=!1,this.coreModel=e,this.settings=t,this.motionManager=new te(t,s),this.eyeBlink=new se(e),this.eyeballXParamIndex=e.getParamIndex("PARAM_EYE_BALL_X"),this.eyeballYParamIndex=e.getParamIndex("PARAM_EYE_BALL_Y"),this.angleXParamIndex=e.getParamIndex("PARAM_ANGLE_X"),this.angleYParamIndex=e.getParamIndex("PARAM_ANGLE_Y"),this.angleZParamIndex=e.getParamIndex("PARAM_ANGLE_Z"),this.bodyAngleXParamIndex=e.getParamIndex("PARAM_BODY_ANGLE_X"),this.breathParamIndex=e.getParamIndex("PARAM_BREATH"),this.mouthFormIndex=e.getParamIndex("PARAM_MOUTH_FORM"),this.init()}init(){super.init(),this.settings.initParams&&this.settings.initParams.forEach((({id:e,value:t})=>this.coreModel.setParamFloat(e,t))),this.settings.initOpacities&&this.settings.initOpacities.forEach((({id:e,value:t})=>this.coreModel.setPartsOpacity(e,t))),this.coreModel.saveParam();const e=this.coreModel.getModelContext()._$aS;(null==e?void 0:e.length)&&(this.drawDataCount=e.length);let t=this.coreModel.drawParamWebGL.culling;Object.defineProperty(this.coreModel.drawParamWebGL,"culling",{set:e=>t=e,get:()=>!this.disableCulling&&t});const s=this.coreModel.getModelContext().clipManager,i=s.setupClip;s.setupClip=(e,t)=>{i.call(s,e,t),t.gl.viewport(...this.viewport)}}getSize(){return[this.coreModel.getCanvasWidth(),this.coreModel.getCanvasHeight()]}getLayout(){const e={};if(this.settings.layout)for(const t of Object.keys(this.settings.layout)){let s=t;"center_x"===t?s="centerX":"center_y"===t&&(s="centerY"),e[s]=this.settings.layout[t]}return e}updateWebGLContext(e,t){const s=this.coreModel.drawParamWebGL;s.firstDraw=!0,s.setGL(e),s.glno=t;for(const o in s)s.hasOwnProperty(o)&&s[o]instanceof WebGLBuffer&&(s[o]=null);const i=this.coreModel.getModelContext().clipManager;i.curFrameNo=t;const r=e.getParameter(e.FRAMEBUFFER_BINDING);i.getMaskRenderTexture(),e.bindFramebuffer(e.FRAMEBUFFER,r)}bindTexture(e,t){this.coreModel.setTexture(e,t)}getHitAreaDefs(){var e;return(null==(e=this.settings.hitAreas)?void 0:e.map((e=>({id:e.id,name:e.name,index:this.coreModel.getDrawDataIndex(e.id)}))))||[]}getDrawableIDs(){const e=this.coreModel.getModelContext(),t=[];for(let s=0;s<this.drawDataCount;s++){const i=e.getDrawData(s);i&&t.push(i.getDrawDataID().id)}return t}getDrawableIndex(e){return this.coreModel.getDrawDataIndex(e)}getDrawableVertices(e){if("string"==typeof e&&-1===(e=this.coreModel.getDrawDataIndex(e)))throw new TypeError("Unable to find drawable ID: "+e);return this.coreModel.getTransformedPoints(e).slice()}update(e,t){var s,i,r,o;super.update(e,t);const n=this.coreModel;this.emit("beforeMotionUpdate");const a=this.motionManager.update(this.coreModel,t);if(this.emit("afterMotionUpdate"),n.saveParam(),null==(s=this.motionManager.expressionManager)||s.update(n,t),a||null==(i=this.eyeBlink)||i.update(e),this.updateFocus(),this.updateNaturalMovements(e,t),this.lipSync&&this.motionManager.currentAudio){let e=this.motionManager.mouthSync(),t=0;e>0&&(t=.4),e=d(e*1.2,t,1);for(let s=0;s<this.motionManager.lipSyncIds.length;++s)this.coreModel.setParamFloat(this.coreModel.getParamIndex(this.motionManager.lipSyncIds[s]),e)}null==(r=this.physics)||r.update(t),null==(o=this.pose)||o.update(e),this.emit("beforeModelUpdate"),n.update(),n.loadParam()}updateFocus(){this.coreModel.addToParamFloat(this.eyeballXParamIndex,this.focusController.x),this.coreModel.addToParamFloat(this.eyeballYParamIndex,this.focusController.y),this.coreModel.addToParamFloat(this.angleXParamIndex,30*this.focusController.x),this.coreModel.addToParamFloat(this.angleYParamIndex,30*this.focusController.y),this.coreModel.addToParamFloat(this.angleZParamIndex,this.focusController.x*this.focusController.y*-30),this.coreModel.addToParamFloat(this.bodyAngleXParamIndex,10*this.focusController.x)}updateNaturalMovements(e,t){const s=t/1e3*2*Math.PI;this.coreModel.addToParamFloat(this.angleXParamIndex,15*Math.sin(s/6.5345)*.5),this.coreModel.addToParamFloat(this.angleYParamIndex,8*Math.sin(s/3.5345)*.5),this.coreModel.addToParamFloat(this.angleZParamIndex,10*Math.sin(s/5.5345)*.5),this.coreModel.addToParamFloat(this.bodyAngleXParamIndex,4*Math.sin(s/15.5345)*.5),this.coreModel.setParamFloat(this.breathParamIndex,.5+.5*Math.sin(s/3.2345))}draw(e){const t=this.disableCulling;e.getParameter(e.FRAMEBUFFER_BINDING)&&(this.disableCulling=!0);const s=this.drawingMatrix;ie[0]=s.a,ie[1]=s.b,ie[4]=s.c,ie[5]=s.d,ie[12]=s.tx,ie[13]=s.ty,this.coreModel.setMatrix(ie),this.coreModel.draw(),this.disableCulling=t}destroy(){super.destroy(),this.coreModel=void 0}}class oe extends y{constructor(e){if(super(e),this.motions={},!oe.isValidJSON(e))throw new TypeError("Invalid JSON.");this.moc=e.model,c("string",e,this,"textures","textures"),this.copy(e)}static isValidJSON(e){var t;return!!e&&"string"==typeof e.model&&(null==(t=e.textures)?void 0:t.length)>0&&e.textures.every((e=>"string"==typeof e))}copy(e){u("string",e,this,"name","name"),u("string",e,this,"pose","pose"),u("string",e,this,"physics","physics"),u("object",e,this,"layout","layout"),u("object",e,this,"motions","motions"),c("object",e,this,"hit_areas","hitAreas"),c("object",e,this,"expressions","expressions"),c("object",e,this,"init_params","initParams"),c("object",e,this,"init_opacities","initOpacities")}replaceFiles(e){super.replaceFiles(e);for(const[t,s]of Object.entries(this.motions))for(let i=0;i<s.length;i++)s[i].file=e(s[i].file,`motions.${t}[${i}].file`),void 0!==s[i].sound&&(s[i].sound=e(s[i].sound,`motions.${t}[${i}].sound`));if(this.expressions)for(let t=0;t<this.expressions.length;t++)this.expressions[t].file=e(this.expressions[t].file,`expressions[${t}].file`)}}const ne={x:PhysicsHair.Src.SRC_TO_X,y:PhysicsHair.Src.SRC_TO_Y,angle:PhysicsHair.Src.SRC_TO_G_ANGLE},ae={x:PhysicsHair.Src.SRC_TO_X,y:PhysicsHair.Src.SRC_TO_Y,angle:PhysicsHair.Src.SRC_TO_G_ANGLE};class le{constructor(e,t){this.coreModel=e,this.physicsHairs=[],t.physics_hair&&(this.physicsHairs=t.physics_hair.map((e=>{const t=new PhysicsHair;return t.setup(e.setup.length,e.setup.regist,e.setup.mass),e.src.forEach((({id:e,ptype:s,scale:i,weight:r})=>{const o=ne[s];o&&t.addSrcParam(o,e,i,r)})),e.targets.forEach((({id:e,ptype:s,scale:i,weight:r})=>{const o=ae[s];o&&t.addTargetParam(o,e,i,r)})),t})))}update(e){this.physicsHairs.forEach((t=>t.update(this.coreModel,e)))}}class de{constructor(e){this.id=e,this.paramIndex=-1,this.partsIndex=-1,this.link=[]}initIndex(e){this.paramIndex=e.getParamIndex("VISIBLE:"+this.id),this.partsIndex=e.getPartsDataIndex(PartsDataID.getID(this.id)),e.setParamFloat(this.paramIndex,1)}}class he{constructor(e,t){this.coreModel=e,this.opacityAnimDuration=500,this.partsGroups=[],t.parts_visible&&(this.partsGroups=t.parts_visible.map((({group:e})=>e.map((({id:e,link:t})=>{const s=new de(e);return t&&(s.link=t.map((e=>new de(e)))),s})))),this.init())}init(){this.partsGroups.forEach((e=>{e.forEach((e=>{if(e.initIndex(this.coreModel),e.paramIndex>=0){const t=0!==this.coreModel.getParamFloat(e.paramIndex);this.coreModel.setPartsOpacity(e.partsIndex,t?1:0),this.coreModel.setParamFloat(e.paramIndex,t?1:0),e.link.length>0&&e.link.forEach((e=>e.initIndex(this.coreModel)))}}))}))}normalizePartsOpacityGroup(e,t){const s=this.coreModel,i=.5;let r=1,o=e.findIndex((({paramIndex:e,partsIndex:t})=>t>=0&&0!==s.getParamFloat(e)));if(o>=0){const i=s.getPartsOpacity(e[o].partsIndex);r=d(i+t/this.opacityAnimDuration,0,1)}else o=0,r=1;e.forEach((({partsIndex:e},t)=>{if(e>=0)if(o==t)s.setPartsOpacity(e,r);else{let t,o=s.getPartsOpacity(e);t=r<i?-.5*r/i+1:(1-r)*i/.5,(1-t)*(1-r)>.15&&(t=1-.15/(1-r)),o>t&&(o=t),s.setPartsOpacity(e,o)}}))}copyOpacity(e){const t=this.coreModel;e.forEach((({partsIndex:e,link:s})=>{if(e>=0&&s){const i=t.getPartsOpacity(e);s.forEach((({partsIndex:e})=>{e>=0&&t.setPartsOpacity(e,i)}))}}))}update(e){this.partsGroups.forEach((t=>{this.normalizePartsOpacityGroup(t,e),this.copyOpacity(t)}))}}N.registerRuntime({version:2,test:e=>e instanceof oe||oe.isValidJSON(e),ready:()=>Promise.resolve(),isValidMoc(e){if(e.byteLength<3)return!1;const t=new Int8Array(e,0,3);return"moc"===String.fromCharCode(...t)},createModelSettings:e=>new oe(e),createCoreModel(e){const t=Live2DModelWebGL.loadModel(e),s=Live2D.getError();if(s)throw s;return t},createInternalModel:(e,t,s)=>new re(e,t,s),createPose:(e,t)=>new he(e,t),createPhysics:(e,t)=>new le(e,t)}),e.Cubism2ExpressionManager=ee,e.Cubism2InternalModel=re,e.Cubism2ModelSettings=oe,e.Cubism2MotionManager=te,e.ExpressionManager=f,e.FileLoader=B,e.FocusController=x,e.InteractionMixin=j,e.InternalModel=I,e.LOGICAL_HEIGHT=2,e.LOGICAL_WIDTH=2,e.Live2DExpression=K,e.Live2DEyeBlink=se,e.Live2DFactory=N,e.Live2DLoader=A,e.Live2DModel=Y,e.Live2DPhysics=le,e.Live2DPose=he,e.Live2DTransform=W,e.ModelSettings=y,e.MotionManager=P,e.MotionPreloadStrategy=w,e.MotionPriority=M,e.MotionState=v,e.SoundManager=E,e.VERSION="0.4.0",e.XHRLoader=T,e.ZipLoader=Z,e.applyMixins=p,e.clamp=d,e.copyArray=c,e.copyProperty=u,e.folderName=g,e.logger=l,e.rand=h,e.remove=m,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
